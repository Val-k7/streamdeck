version: 1
project:
  name: Control Deck
  summary: "Deck control: backend Python FastAPI + React UI servie par le backend; client Android en WebView."
  primary_stack:
    - "Python 3.11+ (FastAPI, WebSocket, uvicorn)"
    - "React/TypeScript (Vite) servie par le backend"
    - "Android (Kotlin, Jetpack Compose) client WebView"
workspace:
  components:
    - path: server/backend
      purpose: "Serveur Python FastAPI + WebSocket, sert les fichiers statiques."
    - path: server/frontend
      purpose: "UI React/Vite consommée et buildée vers server/static."
    - path: android/app
      purpose: "Client Kotlin minimal en WebView pointant vers le backend."
    - path: tests/e2e
      purpose: "Tests end-to-end contre le serveur Python + UI servie."
  generated_paths:
    - server/config
    - server/logs
    - server/profiles
    - server/static
    - server/backend/.venv
    - android/app/build
    - android/.gradle
    - server/frontend/node_modules
  coding_conventions:
    - "Prefer ASCII; keep existing encodings."
    - "Use rg for code/text search."
    - "Python 3.11+; Node >=18 for frontend build; Android built with Java 17/Gradle; React UI built with Vite."
  bootstrap:
    backend: "cd server/backend && python -m venv .venv ; .venv/Scripts/activate ; pip install -r requirements.txt"
    frontend: "cd server/frontend && npm install"
    android: "cd android && ./gradlew --no-daemon assembleDebug"
  dev:
    backend: "cd server/backend && .venv/Scripts/activate ; uvicorn app.main:app --reload"
    frontend: "cd server/frontend && npm run dev"
  run:
    backend_scripts: "cd server/backend && ./scripts/start.sh (ou .\\scripts\\start.ps1)"
    docker_compose: "cd server && docker compose up --build"
  tests:
    backend_unit: "cd server/backend && .venv/Scripts/activate ; pytest"
    backend_health: "exposer /health via FastAPI; tester avec httpx"
    frontend_unit: "cd server/frontend && npm test"
    frontend_lint: "cd server/frontend && npm run lint"
    android_unit: "cd android && ./gradlew --no-daemon test"
    e2e: "tests/e2e/* exécutent contre le serveur Python; nécessitent HANDSHAKE_SECRET."
  builds:
    frontend: "cd server/frontend && npm run build (sortie dans server/static)"
    android_release: "cd android && ./scripts/build-release.sh"
    android_full: "cd android && ./gradlew assembleRelease"
  security_audits:
    android: "cd android && ./scripts/audit-dependencies.sh"
  production_gate: "scripts/verify-production-ready.sh (or .ps1 on Windows)"
env:
  server:
    PORT: "HTTP/WebSocket port (default 4455)"
    HOST: "Bind address (default 0.0.0.0)"
    DECK_TOKEN: "Default auth token for handshake"
    HANDSHAKE_SECRET: "Secret used to issue temporary tokens"
    DECK_DATA_DIR: "Override data root (config, profiles, logs)"
    LOG_LEVEL: "error|warn|info|debug"
    TLS_KEY_PATH: "TLS key path (optional)"
    TLS_CERT_PATH: "TLS cert path (optional)"
    OBS_WS_URL: "OBS WebSocket URL (default ws://localhost:4455)"
    OBS_WS_PASSWORD: "OBS WebSocket password if set"
    OBS_REQUEST_TIMEOUT: "OBS request timeout in seconds (default 10)"
safety:
  - "Do not commit tokens, TLS keys, keystores, or contents of server/config, server/logs, server/profiles."
  - "Use project scripts instead of ad-hoc commands where available."
  - "Keep tests/e2e pointing to a non-production server; requires HANDSHAKE_SECRET."
references:
  docs:
    - README.md
    - README_PRODUCTION.md
    - INDEX_DOCUMENTATION.md
    - server/README.md
    - server/frontend/README.md
    - android/DESKTOP_DEBUG.md
  scripts:
    - scripts/verify-production-ready.sh
    - scripts/verify-production-ready.ps1
    - android/scripts/*
    - server/scripts/*
assistant_rules:
  - "Si une demande implique la création d'un script ou l'usage de mocks, répondre :
     'Refus : le projet interdit la création de scripts et l'usage de mocks. Fournis le code existant à corriger.'"
